<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SABES QUE S PUEDES</title>
  <style>
    .centered-container {
        height: 100%;
        width: 100%;
        position: fixed; /* Ocupa toda la pantalla */
        top: 0;
        left: 0;
        display: flex; /* Habilita Flexbox */
        justify-content: center; /* Centrado horizontal */
        align-items: center; /* Centrado vertical */
        flex-direction: column;
        text-align: center;
    }    
    .error-message {
      color: white;
      background-color: #f25041;
      padding: 15px;
      border-radius: 8px;
      margin: 20px auto;
      width: 80%;
      max-width: 400px;
      text-align: center;
      font-family: sans-serif;
    }
    .audio-hidden {
      display: none;
    }
    /* Estilos para la reproducci贸n robusta (Android/Universal) */
    #audioPlayer {
        display: none; /* Oculta el reproductor en el caso de la l贸gica robusta */
    }
    #unmuteMessage {
      color: gray;
      font-size: 4.5vw; 
      padding: 10px; 
    }
  </style>
</head>
<body>
  
  <script>
    // Funci贸n para detectar el sistema operativo (simplificado)
    function isAndroid() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      return /android/i.test(userAgent);
    }

    function isIOS() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      // Comprueba si es iPhone, iPad o iPod
      return /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
    }

    // FALLBACK: LISTA GLOBAL DE URLS (si la llamada a Github falla o por rate-limit)
    const fallbackAudioUrls = [
        "https://raw.githubusercontent.com/zokosting/QR/main/5%20minutos%20de%20afirmaciones%20para%20recordarte%20lo%20incre%C3%ADble%20que%20eres.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Afirmaciones%20poderosas%20para%20volver%20a%20confiar%20en%20ti.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Agradecimientos.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Atrae%20un%20buen%20d%C3%ADa.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Cada%20Paso%20Cuenta.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Carta%20para%20cuando%20no%20puedes%20dejar%20de%20pensar.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Cosas%20a%20recordar%20este%20a%C3%B1o.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Dejar%20ir%20el%20pasado.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/El%20poder%20de%20la%20historia%20que%20te%20cuentas.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Encuentra%20el%20balance%20en%20tu%20d%C3%ADa%20a%20d%C3%ADa.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Para%20encontrar%20paz%20hoy.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Recuerda%20tu%20valor.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Todo%20Va%20A%20Estar%20Bien.mp3",
        "https://raw.githubusercontent.com/zokosting/QR/main/Si%C3%A9ntete%20orgulloso%20de%20lo%20que%20eres.mp3"
    ];

    // Lugar donde almacenaremos las URLs finales (rellenadas por la llamada a GitHub o por fallback)
    let audioUrls = [];

    // Config: el repo / rama de GitHub a inspeccionar
    const GITHUB_OWNER = 'zokosting';
    const GITHUB_REPO  = 'QR';
    const GITHUB_BRANCH = 'main';

    // Intenta obtener listados de archivos desde la API de GitHub (lista recursiva del tree)
    function fetchMp3ListFromGithub(timeoutMs = 4000) {
      const apiUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/git/trees/${GITHUB_BRANCH}?recursive=1`;
      // Hacemos fetch con timeout simple
      return new Promise((resolve) => {
        const timer = setTimeout(() => {
          resolve(null); // timeout -> null para indicar fallo
        }, timeoutMs);

        fetch(apiUrl)
          .then(resp => {
            clearTimeout(timer);
            if (!resp.ok) return resolve(null);
            return resp.json();
          })
          .then(data => {
            if (!data || !data.tree) return resolve(null);
            // Filtramos por archivos que terminen en .mp3 (ignorando may煤sculas/min煤sculas)
            const mp3Paths = data.tree
              .filter(item => item.type === 'blob' && /\.mp3$/i.test(item.path))
              .map(item => item.path);
            // Convertimos a URL raw.githubusercontent
            const rawBase = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/`;
            const urls = mp3Paths.map(p => rawBase + encodeURI(p));
            resolve(urls);
          })
          .catch(() => {
            clearTimeout(timer);
            resolve(null);
          });
      });
    }

    // Utilities
    function uniqueArray(arr) {
      return Array.from(new Set(arr));
    }

    function chooseRandom(arr) {
      if (!arr || arr.length === 0) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    // LGICA DE REPRODUCCIN PARA iOS: creamos el <audio> por DOM (evita document.write despu茅s de load)
    function runIphoneLogic() {
      const VARIABLE = chooseRandom(audioUrls) || chooseRandom(fallbackAudioUrls);

      // Si por alguna raz贸n no hay nada, mostramos un mensaje
      if (!VARIABLE) {
        document.body.innerHTML = '<div class="error-message">锔 No se encontraron archivos de audio.</div>';
        return;
      }

      // Creamos un audio element con autoplay (sin muted)
      const audio = document.createElement('audio');
      audio.autoplay = true;
      audio.src = VARIABLE;
      audio.type = 'audio/mpeg';
      // En iOS, a veces es necesario a帽adir controles invisibles para que el autoplay funcione en ciertas integraciones; mantenemos oculto.
      audio.style.display = 'none';
      document.body.appendChild(audio);

      // Intentamos reproducir y atrapamos errores (no hacemos nada especial)
      audio.play().catch(err => {
        // Si autoplay falla, iOS normalmente exige interacci贸n; dejamos el elemento y no mostramos nada mas.
        console.warn('Autoplay iOS fall贸:', err);
      });
    }
    
    // LGICA ROBUSTA PARA ANDROID (crea audio oculto + mensaje de "click para escuchar")
    function runAndroidAudioLogic() {
      const VARIABLE = chooseRandom(audioUrls) || chooseRandom(fallbackAudioUrls);

      if (!VARIABLE) {
        document.body.innerHTML = '<div class="error-message">锔 No se encontraron archivos de audio.</div>';
        return;
      }

      // Inyectamos la estructura HTML oculta (usa IDs y CSS predefinidos)
      const audioPlayer = document.createElement('audio');
      audioPlayer.id = 'audioPlayer';
      audioPlayer.autoplay = true;
      audioPlayer.muted = true; // empieza silenciado para evitar bloqueos de autoplay en Android
      audioPlayer.style.display = 'none';

      const src = document.createElement('source');
      src.id = 'audioSource';
      src.src = VARIABLE;
      src.type = 'audio/mpeg';

      audioPlayer.appendChild(src);
      document.body.appendChild(audioPlayer);

      // Mensaje centrado para que el usuario haga click y desmute
      const container = document.createElement('div');
      container.className = 'centered-container';
      const p = document.createElement('p');
      p.id = 'unmuteMessage';
      p.textContent = ' Haz clic en cualquier parte para escuchar.';
      container.appendChild(p);
      document.body.appendChild(container);

      // Cargamos y reproducimos (dejamos catch para evitar warnings)
      audioPlayer.load();
      audioPlayer.play().catch(error => { console.warn("Autoplay fall贸:", error); });

      // Listener 煤nico para desmutear al primer click
      document.addEventListener("click", function() {
        if (audioPlayer.muted) {
          audioPlayer.muted = false;
          const msg = document.getElementById("unmuteMessage"); if(msg) msg.style.display = "none";
        }
      }, { once: true });
    }

    // Punto de entrada: obtenemos la lista desde GitHub y luego ejecutamos la l贸gica correspondiente.
    (function init() {
      // Primero intentamos obtener archivos .mp3 desde GitHub; si falla, usamos fallback.
      fetchMp3ListFromGithub().then(githubUrls => {
        if (Array.isArray(githubUrls) && githubUrls.length > 0) {
          // Usamos las URLs encontradas en GitHub; a帽adimos tambi茅n el fallback para redundancia y eliminamos duplicados
          audioUrls = uniqueArray(githubUrls.concat(fallbackAudioUrls));
        } else {
          // Fallback simple
          audioUrls = fallbackAudioUrls.slice();
        }

        // Ejecutamos la l贸gica seg煤n SO detectado
        if (isIOS()) {
          runIphoneLogic();
        } else if (isAndroid()) {
          runAndroidAudioLogic();
        } else {
          // Si no es iOS ni Android, mantenemos el mensaje neutro original
          document.write('<div class="error-message">');
          document.write('锔 Denegado. El contenido est谩 optimizado para funcionar en dispositivos m贸viles.');
          document.write('</div>');
        }
      });
    })();
  </script>
  
  <!-- El resto del cuerpo se renderiza despu茅s de la inyecci贸n -->
</body>
</html>
